<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\Clouds\MegaNZ\Self-Development\Android_Xamarin\PrivateGallery\PrivateGallery.Tests\UnitTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Newtonsoft.Json;
using PrivateGallery.Common.BindingModels;
using PrivateGallery.Tests;

namespace PrivateGallery.Tests
{
    [TestClass]
    //TODO: need refactoring
    public partial class UnitTests
    {
        private readonly string _email = &quot;harrisonford@gmail.com&quot;;
        private readonly string _password = &quot;Mark95!&quot;;
        //private readonly string _host = &quot;http://192.168.0.102:57643&quot;;
        private readonly string _host = &quot;http://safecloud.azurewebsites.net&quot;;
        private readonly string _gallery = &quot;/api/Folder&quot;;
        private readonly string _picture = &quot;/api/File&quot;;
        private readonly string _oldName = &quot;Little Cars&quot;;
        private readonly string _newName = &quot;Hype-Cars&quot;;
        private string MimeJson =&gt; &quot;application/json&quot;;
        string FolderId;
        string FileId;

        private  string _token ;

        private string gallerypath= &quot;gallery.txt&quot;;
        private string photopath = &quot;photo.txt&quot;;
        private string tokenpath = &quot;token.txt&quot;;
        /// &lt;summary&gt;
        /// #1 Get concrete user`s authorization token 
        /// &lt;/summary&gt;
        [TestMethod]
        public void GetToken()
        {
            var pairs = new List&lt;KeyValuePair&lt;string, string&gt;&gt;
            {
                new KeyValuePair&lt;string, string&gt;(&quot;grant_type&quot;, &quot;password&quot;),
                new KeyValuePair&lt;string, string&gt;(&quot;username&quot;, _email),
                new KeyValuePair&lt;string, string&gt;(&quot;Password&quot;, _password)
            };
            var content = new FormUrlEncodedContent(pairs);
            UserToken res = null;
            Send();

            Assert.IsTrue(!string.IsNullOrEmpty(res.AccessToken));


            void Send()
            {
                using (var client = new HttpClient())
                {
                    var _responseMessage =
                        client.PostAsync(_host + &quot;/token&quot;,
                                content)
                            .Result;
                    String result = _responseMessage.Content.ReadAsStringAsync().Result;
                    if (_responseMessage.IsSuccessStatusCode)
                    {
                        res = JsonConvert.DeserializeObject&lt;UserToken&gt;(result);
                        File.WriteAllText(tokenpath,res.AccessToken);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// #2  Are obtained data correct?
        /// &lt;/summary&gt;
        [TestMethod]
        public void IsCorrectUserInfo()
        {
            _token = File.ReadAllText(tokenpath);
            string url = &quot;/api/Account/AccountInfo&quot;;
            HttpRequestMessage requestMessage = new HttpRequestMessage(HttpMethod.Get, _host + url);
            requestMessage.Headers.Authorization = new AuthenticationHeaderValue(&quot;Bearer&quot;, _token);

            string key = &quot;Email&quot;;
            Dictionary&lt;string, string&gt; dictionary = null;
            Send();


            Assert.IsTrue(dictionary.Any() &amp;&amp; dictionary.ContainsKey(key) &amp;&amp; dictionary[key] == _email);

            void Send()
            {
                using (var client = new HttpClient())
                {
                    var response = client.SendAsync(requestMessage).Result;
                    if (response.IsSuccessStatusCode)
                    {
                        dictionary =
                            JsonConvert.DeserializeObject&lt;Dictionary&lt;string, string&gt;&gt;(response.Content
                                .ReadAsStringAsync()
                                .Result);
                    }
                    else
                    {
                        dictionary = new Dictionary&lt;string, string&gt;()
                        {
                            {&quot;error&quot;, &quot;error&quot;}
                        };
                    }
                }
            }

        }

        /// &lt;summary&gt;
        /// #3 Restore user password
        /// &lt;/summary&gt;
        [TestMethod]
        public void RestorePassword()
        {
            _token = File.ReadAllText(tokenpath);
            RestorePasswordBindingModel model =
                new RestorePasswordBindingModel()
                {
                    Email = _email,
                    ConfirmPassword = _password,
                    NewPassword = _password
                };
            HttpResponseMessage message;
            Send();

            Assert.IsTrue(message.IsSuccessStatusCode);



            void Send()
            {
                using (var client = new HttpClient())
                {
                    message = client.PostAsync(_host + &quot;/api/Account/RestorePassword&quot;,
                            new StringContent(JsonConvert.SerializeObject(model), Encoding.UTF8,
                                MimeJson))
                        .Result;
                }
            }
        }

        /// &lt;summary&gt;
        /// #4 Create new Gallery
        /// &lt;/summary&gt;
        [TestMethod]
        public void CreateGallery()
        {
            _token = File.ReadAllText(tokenpath);
            GalleryBindindModel model = new GalleryBindindModel {DateTime = DateTime.Now, Name = _oldName};
            Tuple&lt;bool, string&gt; body = OperateData(model, _gallery, new HttpClient(), HttpMethod.Put);
            File.WriteAllText(gallerypath,body.Item2);
            Assert.IsTrue(body.Item1);
        }

        /// &lt;summary&gt;
        /// #5 Renaming Gallery
        /// &lt;/summary&gt;
        [TestMethod]
        public void RenameGallery()
        {
            _token = File.ReadAllText(tokenpath);
            FolderId = File.ReadAllText(gallerypath);
            GalleryBindindModel model = new GalleryBindindModel {Id = FolderId, NewName = _newName};
            Tuple&lt;bool, string&gt; body = OperateData(model, _gallery, new HttpClient(), new HttpMethod(&quot;PATCH&quot;));
            Assert.IsTrue(body.Item1);
        }

        /// &lt;summary&gt;
        /// #6 Get a renamed gallery
        /// &lt;/summary&gt;
        [TestMethod]
        public void GetConcreteGallery()
        {
            _token = File.ReadAllText(tokenpath);
            GalleryBindindModel model = new GalleryBindindModel();
            Send();

            Assert.IsTrue(model.Name == _newName);

            void Send()
            {
                FolderId = File.ReadAllText(gallerypath);
                var param = $&quot;/api/Folder?id={FolderId}&quot;;
                HttpRequestMessage requestMessage =
                    HttpRequestMessageCreator.CreateHeaderRequestMessage(HttpMethod.Get,
                        $&quot;{_host}{param}&quot;, _token);
                using (var client = new HttpClient())
                {
                    var response = client.SendAsync(requestMessage).Result;
                    if (response.IsSuccessStatusCode)
                    {
                        model =
                            JsonConvert.DeserializeObject&lt;GalleryBindindModel&gt;(response.Content.ReadAsStringAsync()
                                .Result);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// #7 Looking for in gallery list
        /// &lt;/summary&gt;
        [TestMethod]
        public void FindGallery()
        {
            _token = File.ReadAllText(tokenpath);
            List&lt;GalleryStructure&gt; list = null;

            var requestMessage =
                HttpRequestMessageCreator.CreateHeaderRequestMessage(HttpMethod.Get, $&quot;{_host}{&quot;/api/Folder/List&quot;}&quot;,
                    _token);


            using (var client = new HttpClient())
            {
                var responseMessage = client.SendAsync(requestMessage).Result;
                list = responseMessage.IsSuccessStatusCode
                    ? JsonConvert.DeserializeObject&lt;List&lt;GalleryStructure&gt;&gt;(responseMessage.Content.ReadAsStringAsync()
                        .Result)
                    : null;
            }
            Assert.IsTrue(list.Any(x =&gt; x.Name == _newName));
        }

        /// &lt;summary&gt;
        /// #8 Upload photo
        /// &lt;/summary&gt;
        [TestMethod]
        public void PutPhoto()
        {
            _token = File.ReadAllText(tokenpath);
            FolderId = File.ReadAllText(gallerypath);
            PictureBindingModel model = new PictureBindingModel
            {
                DateTime = DateTime.Now,
                Name = &quot;photo.png&quot;,
                ParentId = FolderId,
                Geolocation = &quot;Lviv&quot;
            };
            Tuple&lt;bool, string&gt; body = OperateData(model, _picture, new HttpClient(), HttpMethod.Put);
            File.WriteAllText(photopath,body.Item2);
            Assert.IsTrue(body.Item1);
        }

        /// &lt;summary&gt;
        /// #9 Delete photo
        /// &lt;/summary&gt;
        [TestMethod]
        public void DeletePhoto()
        {
            _token = File.ReadAllText(tokenpath);
            FileId = File.ReadAllText(photopath);
            PictureBindingModel model = new PictureBindingModel
            {
                Id = FileId
            };
            Tuple&lt;bool, string&gt; body = OperateData(model, _picture, new HttpClient(), HttpMethod.Delete);
            Assert.IsTrue(body.Item1);
        }

        /// &lt;summary&gt;
        /// #10 Delete Gallery
        /// &lt;/summary&gt;
        [TestMethod]
        public void DeleteGallery()
        {
            _token = File.ReadAllText(tokenpath);
            FolderId = File.ReadAllText(gallerypath);
            GalleryBindindModel model = new GalleryBindindModel {Id = FolderId};
            Tuple&lt;bool, string&gt; body = OperateData(model, _gallery, new HttpClient(), HttpMethod.Delete);
            Assert.IsTrue(body.Item1);
        }

        #region Helpers

        /// &lt;summary&gt;
        /// Operating data with some methods: PATH,DELETE,PUT
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;model&quot;&gt;any model&lt;/param&gt;
        /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;client&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;Http Method&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Tuple&lt;bool, string&gt; OperateData&lt;T&gt;(T model, string url, HttpClient client, HttpMethod method)
        {
            var requestMessage =
                HttpRequestMessageCreator.CreateHeaderRequestMessage(method, $&quot;{_host}{url}&quot;, _token);
            requestMessage.Content = new StringContent(JsonConvert.SerializeObject(model), Encoding.UTF8,
                MimeJson);
            var responseMessage = client.SendAsync(requestMessage).Result;
            return new Tuple&lt;bool, string&gt;(responseMessage.IsSuccessStatusCode,
                responseMessage.Content.ReadAsStringAsync().Result.Replace(&quot;\&quot;&quot;, &quot;&quot;));
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,67,0],[20,9,20,55,0],[22,9,22,78,0],[23,9,23,58,0],[24,9,24,56,0],[25,9,25,58,0],[26,9,26,56,0],[27,36,27,54,0],[33,9,33,51,0],[34,9,34,48,0],[35,9,35,48,0],[41,9,41,10,0],[42,13,47,15,0],[48,13,48,60,0],[49,13,49,34,0],[50,13,50,20,0],[52,13,52,67,0],[71,9,71,10,0],[78,9,78,10,0],[79,13,79,50,0],[80,13,80,53,0],[81,13,81,101,0],[82,13,82,100,0],[84,13,84,34,0],[85,13,85,58,0],[86,13,86,20,0],[89,13,89,105,0],[113,9,113,10,0],[120,9,120,10,0],[121,13,121,50,0],[122,13,128,19,0],[130,13,130,20,0],[132,13,132,56,0],[146,9,146,10,0],[153,9,153,10,0],[154,13,154,50,0],[155,13,155,108,0],[156,13,156,103,0],[157,13,157,55,0],[158,13,158,39,0],[159,9,159,10,0],[166,9,166,10,0],[167,13,167,50,0],[168,13,168,54,0],[169,13,169,101,0],[170,13,170,112,0],[171,13,171,39,0],[172,9,172,10,0],[179,9,179,10,0],[180,13,180,50,0],[181,13,181,67,0],[182,13,182,20,0],[184,13,184,51,0],[204,9,204,10,0],[211,9,211,10,0],[212,13,212,50,0],[213,13,213,48,0],[215,13,217,29,0],[220,20,220,49,0],[221,13,221,14,0],[222,17,222,79,0],[223,17,226,28,0],[227,13,227,14,0],[228,13,228,41,0],[228,41,228,59,0],[228,59,228,62,0],[228,13,228,62,0],[229,9,229,10,0],[236,9,236,10,0],[237,13,237,50,0],[238,13,238,54,0],[239,13,245,15,0],[246,13,246,103,0],[247,13,247,53,0],[248,13,248,39,0],[249,9,249,10,0],[256,9,256,10,0],[257,13,257,50,0],[258,13,258,50,0],[259,13,262,15,0],[263,13,263,106,0],[264,13,264,39,0],[265,9,265,10,0],[272,9,272,10,0],[273,13,273,50,0],[274,13,274,54,0],[275,13,275,81,0],[276,13,276,106,0],[277,13,277,39,0],[278,9,278,10,0],[292,9,292,10,0],[293,13,294,103,0],[295,13,296,27,0],[297,13,297,75,0],[298,13,299,87,0],[300,9,300,10,0]]);
    </script>
  </body>
</html>