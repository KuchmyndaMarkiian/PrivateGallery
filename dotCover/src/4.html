<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\Clouds\MegaNZ\Self-Development\Android_Xamarin\PrivateGallery\PrivateGallery.Tests\UnitTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Newtonsoft.Json;
using PrivateGallery.Common.BindingModels;
using PrivateGallery.Tests;

namespace PrivateGallery.Tests
{
    [TestClass]
    public partial class UnitTests
    {
        private readonly string _email = &quot;harrisonford@gmail.com&quot;;
        private readonly string _password = &quot;Mark95!&quot;;
        //private readonly string _host = &quot;http://192.168.0.102:57643&quot;;
        private readonly string _host = &quot;http://safecloud.azurewebsites.net&quot;;
        private readonly string _gallery = &quot;/api/Folder&quot;;
        private readonly string _picture = &quot;/api/File&quot;;
        private readonly string _oldName = &quot;Little Cars&quot;;
        private readonly string _newName = &quot;Hype-Cars&quot;;
        private string MimeJson =&gt; &quot;application/json&quot;;
        string FolderId;
        string FileId;

        private  string _token ;

        private string gallerypath= &quot;gallery.txt&quot;;
        private string photopath = &quot;photo.txt&quot;;
        private string tokenpath = &quot;token.txt&quot;;
        /// &lt;summary&gt;
        /// #1 Get concrete user`s authorization token 
        /// &lt;/summary&gt;
        [TestMethod]
        public void GetToken()
        {
            var pairs = new List&lt;KeyValuePair&lt;string, string&gt;&gt;
            {
                new KeyValuePair&lt;string, string&gt;(&quot;grant_type&quot;, &quot;password&quot;),
                new KeyValuePair&lt;string, string&gt;(&quot;username&quot;, _email),
                new KeyValuePair&lt;string, string&gt;(&quot;Password&quot;, _password)
            };
            var content = new FormUrlEncodedContent(pairs);
            UserToken res = null;
            Send();

            Assert.IsTrue(!string.IsNullOrEmpty(res.AccessToken));


            void Send()
            {
                using (var client = new HttpClient())
                {
                    var _responseMessage =
                        client.PostAsync(_host + &quot;/token&quot;,
                                content)
                            .Result;
                    String result = _responseMessage.Content.ReadAsStringAsync().Result;
                    if (_responseMessage.IsSuccessStatusCode)
                    {
                        res = JsonConvert.DeserializeObject&lt;UserToken&gt;(result);
                        File.WriteAllText(tokenpath,res.AccessToken);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// #2  Are obtained data correct?
        /// &lt;/summary&gt;
        [TestMethod]
        public void IsCorrectUserInfo()
        {
            _token = File.ReadAllText(tokenpath);
            string url = &quot;/api/Account/AccountInfo&quot;;
            HttpRequestMessage requestMessage = new HttpRequestMessage(HttpMethod.Get, _host + url);
            requestMessage.Headers.Authorization = new AuthenticationHeaderValue(&quot;Bearer&quot;, _token);

            string key = &quot;Email&quot;;
            Dictionary&lt;string, string&gt; dictionary = null;
            Send();


            Assert.IsTrue(dictionary.Any() &amp;&amp; dictionary.ContainsKey(key) &amp;&amp; dictionary[key] == _email);

            void Send()
            {
                using (var client = new HttpClient())
                {
                    var response = client.SendAsync(requestMessage).Result;
                    if (response.IsSuccessStatusCode)
                    {
                        dictionary =
                            JsonConvert.DeserializeObject&lt;Dictionary&lt;string, string&gt;&gt;(response.Content
                                .ReadAsStringAsync()
                                .Result);
                    }
                    else
                    {
                        dictionary = new Dictionary&lt;string, string&gt;()
                        {
                            {&quot;error&quot;, &quot;error&quot;}
                        };
                    }
                }
            }

        }

        /// &lt;summary&gt;
        /// #3 Restore user password
        /// &lt;/summary&gt;
        [TestMethod]
        public void RestorePassword()
        {
            _token = File.ReadAllText(tokenpath);
            RestorePasswordBindingModel model =
                new RestorePasswordBindingModel()
                {
                    Email = _email,
                    ConfirmPassword = _password,
                    NewPassword = _password
                };
            HttpResponseMessage message;
            Send();

            Assert.IsTrue(message.IsSuccessStatusCode);



            void Send()
            {
                using (var client = new HttpClient())
                {
                    message = client.PostAsync(_host + &quot;/api/Account/RestorePassword&quot;,
                            new StringContent(JsonConvert.SerializeObject(model), Encoding.UTF8,
                                MimeJson))
                        .Result;
                }
            }
        }

        /// &lt;summary&gt;
        /// #4 Create new Gallery
        /// &lt;/summary&gt;
        [TestMethod]
        public void CreateGallery()
        {
            _token = File.ReadAllText(tokenpath);
            GalleryBindindModel model = new GalleryBindindModel {DateTime = DateTime.Now, Name = _oldName};
            Tuple&lt;bool, string&gt; body = OperateData(model, _gallery, new HttpClient(), HttpMethod.Put);
            File.WriteAllText(gallerypath,body.Item2);
            Assert.IsTrue(body.Item1);
        }

        /// &lt;summary&gt;
        /// #5 Renaming Gallery
        /// &lt;/summary&gt;
        [TestMethod]
        public void RenameGallery()
        {
            _token = File.ReadAllText(tokenpath);
            FolderId = File.ReadAllText(gallerypath);
            GalleryBindindModel model = new GalleryBindindModel {Id = FolderId, NewName = _newName};
            Tuple&lt;bool, string&gt; body = OperateData(model, _gallery, new HttpClient(), new HttpMethod(&quot;PATCH&quot;));
            Assert.IsTrue(body.Item1);
        }

        /// &lt;summary&gt;
        /// #6 Get a renamed gallery
        /// &lt;/summary&gt;
        [TestMethod]
        public void GetConcreteGallery()
        {
            _token = File.ReadAllText(tokenpath);
            GalleryBindindModel model = new GalleryBindindModel();
            Send();

            Assert.IsTrue(model.Name == _newName);

            void Send()
            {
                FolderId = File.ReadAllText(gallerypath);
                var param = $&quot;/api/Folder?id={FolderId}&quot;;
                HttpRequestMessage requestMessage =
                    HttpRequestMessageCreator.CreateHeaderRequestMessage(HttpMethod.Get,
                        $&quot;{_host}{param}&quot;, _token);
                using (var client = new HttpClient())
                {
                    var response = client.SendAsync(requestMessage).Result;
                    if (response.IsSuccessStatusCode)
                    {
                        model =
                            JsonConvert.DeserializeObject&lt;GalleryBindindModel&gt;(response.Content.ReadAsStringAsync()
                                .Result);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// #7 Looking for in gallery list
        /// &lt;/summary&gt;
        [TestMethod]
        public void FindGallery()
        {
            _token = File.ReadAllText(tokenpath);
            List&lt;GalleryStructure&gt; list = null;

            var requestMessage =
                HttpRequestMessageCreator.CreateHeaderRequestMessage(HttpMethod.Get, $&quot;{_host}{&quot;/api/Folder/List&quot;}&quot;,
                    _token);


            using (var client = new HttpClient())
            {
                var responseMessage = client.SendAsync(requestMessage).Result;
                list = responseMessage.IsSuccessStatusCode
                    ? JsonConvert.DeserializeObject&lt;List&lt;GalleryStructure&gt;&gt;(responseMessage.Content.ReadAsStringAsync()
                        .Result)
                    : null;
            }
            Assert.IsTrue(list.Any(x =&gt; x.Name == _newName));
        }

        /// &lt;summary&gt;
        /// #8 Upload photo
        /// &lt;/summary&gt;
        [TestMethod]
        public void PutPhoto()
        {
            _token = File.ReadAllText(tokenpath);
            FolderId = File.ReadAllText(gallerypath);
            PictureBindingModel model = new PictureBindingModel
            {
                DateTime = DateTime.Now,
                Name = &quot;photo.png&quot;,
                ParentId = FolderId,
                Geolocation = &quot;Lviv&quot;
            };
            Tuple&lt;bool, string&gt; body = OperateData(model, _picture, new HttpClient(), HttpMethod.Put);
            File.WriteAllText(photopath,body.Item2);
            Assert.IsTrue(body.Item1);
        }

        /// &lt;summary&gt;
        /// #9 Delete photo
        /// &lt;/summary&gt;
        [TestMethod]
        public void DeletePhoto()
        {
            _token = File.ReadAllText(tokenpath);
            FileId = File.ReadAllText(photopath);
            PictureBindingModel model = new PictureBindingModel
            {
                Id = FileId
            };
            Tuple&lt;bool, string&gt; body = OperateData(model, _picture, new HttpClient(), HttpMethod.Delete);
            Assert.IsTrue(body.Item1);
        }

        /// &lt;summary&gt;
        /// #10 Delete Gallery
        /// &lt;/summary&gt;
        [TestMethod]
        public void DeleteGallery()
        {
            _token = File.ReadAllText(tokenpath);
            FolderId = File.ReadAllText(gallerypath);
            GalleryBindindModel model = new GalleryBindindModel {Id = FolderId};
            Tuple&lt;bool, string&gt; body = OperateData(model, _gallery, new HttpClient(), HttpMethod.Delete);
            Assert.IsTrue(body.Item1);
        }

        #region Helpers

        /// &lt;summary&gt;
        /// Operating data with some methods: PATH,DELETE,PUT
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;model&quot;&gt;any model&lt;/param&gt;
        /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;client&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;Http Method&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Tuple&lt;bool, string&gt; OperateData&lt;T&gt;(T model, string url, HttpClient client, HttpMethod method)
        {
            var requestMessage =
                HttpRequestMessageCreator.CreateHeaderRequestMessage(method, $&quot;{_host}{url}&quot;, _token);
            requestMessage.Content = new StringContent(JsonConvert.SerializeObject(model), Encoding.UTF8,
                MimeJson);
            var responseMessage = client.SendAsync(requestMessage).Result;
            return new Tuple&lt;bool, string&gt;(responseMessage.IsSuccessStatusCode,
                responseMessage.Content.ReadAsStringAsync().Result.Replace(&quot;\&quot;&quot;, &quot;&quot;));
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,67,1],[19,9,19,55,1],[21,9,21,78,1],[22,9,22,58,1],[23,9,23,56,1],[24,9,24,58,1],[25,9,25,56,1],[26,36,26,54,1],[32,9,32,51,1],[33,9,33,48,1],[34,9,34,48,1],[40,9,40,10,1],[41,13,46,15,1],[47,13,47,60,1],[48,13,48,34,1],[49,13,49,20,1],[51,13,51,67,1],[70,9,70,10,1],[77,9,77,10,1],[78,13,78,50,1],[79,13,79,53,1],[80,13,80,101,1],[81,13,81,100,1],[83,13,83,34,1],[84,13,84,58,1],[85,13,85,20,1],[88,13,88,105,1],[112,9,112,10,1],[119,9,119,10,1],[120,13,120,50,1],[121,13,127,19,1],[129,13,129,20,1],[131,13,131,56,1],[145,9,145,10,1],[152,9,152,10,1],[153,13,153,50,1],[154,13,154,108,1],[155,13,155,103,1],[156,13,156,55,1],[157,13,157,39,1],[158,9,158,10,1],[165,9,165,10,1],[166,13,166,50,1],[167,13,167,54,1],[168,13,168,101,1],[169,13,169,112,1],[170,13,170,39,1],[171,9,171,10,1],[178,9,178,10,1],[179,13,179,50,1],[180,13,180,67,1],[181,13,181,20,1],[183,13,183,51,1],[203,9,203,10,1],[210,9,210,10,1],[211,13,211,50,1],[212,13,212,48,1],[214,13,216,29,1],[219,20,219,49,1],[220,13,220,14,1],[221,17,221,79,1],[222,17,225,28,1],[226,13,226,14,1],[227,13,227,41,1],[227,41,227,59,1],[227,59,227,62,1],[227,13,227,62,1],[228,9,228,10,1],[235,9,235,10,1],[236,13,236,50,1],[237,13,237,54,1],[238,13,244,15,1],[245,13,245,103,1],[246,13,246,53,1],[247,13,247,39,1],[248,9,248,10,1],[255,9,255,10,1],[256,13,256,50,1],[257,13,257,50,1],[258,13,261,15,1],[262,13,262,106,1],[263,13,263,39,1],[264,9,264,10,1],[271,9,271,10,1],[272,13,272,50,1],[273,13,273,54,1],[274,13,274,81,1],[275,13,275,106,1],[276,13,276,39,1],[277,9,277,10,1],[291,9,291,10,1],[292,13,293,103,1],[294,13,295,27,1],[296,13,296,75,1],[297,13,298,87,1],[299,9,299,10,1]]);
    </script>
  </body>
</html>